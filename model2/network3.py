import torch
import torch.nn as nn
import torch.nn.functional as F


class Net(nn.Module):
    def __init__(self):
        super(Net, self).__init__()
        # Input image size : 28x28

        # Convolution Layer 1 - Output Size - 26
        self.conv1 = nn.Sequential(
            nn.Conv2d(1, 10, kernel_size=3, padding=0, bias=False), # Input Channels - 1, Output Channels - 12
            nn.BatchNorm2d(10),
            nn.Dropout(0.1),
            nn.ReLU()
        )
        
        # Convolution Layer 2 - Output Size - 24
        self.conv2 = nn.Sequential(
            nn.Conv2d(10, 16, kernel_size=3, padding=0, bias=False),
            nn.BatchNorm2d(16),
            nn.Dropout(0.1),
            nn.ReLU()
        )
        
        # Convolution Layer 3 - Output Size - 22
        self.conv3 = nn.Sequential(
            nn.Conv2d(16, 12, kernel_size=3, padding=0, bias=False),
            nn.BatchNorm2d(12),
            nn.Dropout(0.1),
            nn.ReLU()
        )

        # Transition Layer 1 - MaxPool and 1x1 conv - Output Size - 11
        self.transition1 = nn.Sequential(
            nn.Conv2d(12, 10, kernel_size=1, padding=0, bias=False),
            nn.MaxPool2d(2, 2),
        )

        # Convolution Layer 4 - Output Size - 9
        self.conv4 = nn.Sequential(
            nn.Conv2d(10, 16, kernel_size=3, padding=0, bias=False),
            nn.BatchNorm2d(16),
            nn.Dropout(0.1),
            nn.ReLU()
        )

        # Transition Layer 2 - MaxPool and 1x1 conv - Output Size - 4
        #self.transition2 = nn.Sequential(
        #    nn.MaxPool2d(2, 2),
        #    nn.Conv2d(16, 10, kernel_size=1, padding=0, base=False),
        #)
        
        # Convolution Layer 5 - Output Size - 7
        self.conv5 = nn.Sequential(
            nn.Conv2d(16, 16, kernel_size=3, padding=0, bias=False),
            nn.BatchNorm2d(16),
            nn.Dropout(0.1),
            nn.ReLU()
        )

        # Convolution Layer 6 - Output Size - 5
        self.conv6 = nn.Sequential(
            nn.Conv2d(16, 10, kernel_size=3, padding=0, bias=False),
            #nn.BatchNorm2d(10),
            #nn.Dropout(0.1),
            nn.ReLU()
        )
        
        self.gap = nn.AdaptiveAvgPool2d(1)


    def forward(self, x):
        x = self.conv1(x)
        x = self.conv2(x)
        x = self.conv3(x)
        x = self.transition1(x)

        x = self.conv4(x)
        #x = self.transition2(x)

        x = self.conv5(x)
        x = self.conv6(x)

        x = self.gap(x)
        x = x.view(-1, 10) 
        return F.log_softmax(x, dim=-1)




'''
(era3_assignments) sravan@sravan-latitude-3410 ~/Personal/Courses/ERA3/Assignment7/ERAV3_Assignment7/model2 (main)$ python train.py 
----------------------------------------------------------------
        Layer (type)               Output Shape         Param #
================================================================
            Conv2d-1           [-1, 10, 26, 26]              90
       BatchNorm2d-2           [-1, 10, 26, 26]              20
           Dropout-3           [-1, 10, 26, 26]               0
              ReLU-4           [-1, 10, 26, 26]               0
            Conv2d-5           [-1, 16, 24, 24]           1,440
       BatchNorm2d-6           [-1, 16, 24, 24]              32
           Dropout-7           [-1, 16, 24, 24]               0
              ReLU-8           [-1, 16, 24, 24]               0
            Conv2d-9           [-1, 12, 22, 22]           1,728
      BatchNorm2d-10           [-1, 12, 22, 22]              24
          Dropout-11           [-1, 12, 22, 22]               0
             ReLU-12           [-1, 12, 22, 22]               0
           Conv2d-13           [-1, 10, 22, 22]             120
        MaxPool2d-14           [-1, 10, 11, 11]               0
           Conv2d-15             [-1, 16, 9, 9]           1,440
      BatchNorm2d-16             [-1, 16, 9, 9]              32
          Dropout-17             [-1, 16, 9, 9]               0
             ReLU-18             [-1, 16, 9, 9]               0
           Conv2d-19             [-1, 16, 7, 7]           2,304
      BatchNorm2d-20             [-1, 16, 7, 7]              32
          Dropout-21             [-1, 16, 7, 7]               0
             ReLU-22             [-1, 16, 7, 7]               0
           Conv2d-23             [-1, 10, 5, 5]           1,440
             ReLU-24             [-1, 10, 5, 5]               0
AdaptiveAvgPool2d-25             [-1, 10, 1, 1]               0
================================================================
Total params: 8,702
Trainable params: 8,702
Non-trainable params: 0
----------------------------------------------------------------
Input size (MB): 0.00
Forward/backward pass size (MB): 0.78
Params size (MB): 0.03
Estimated Total Size (MB): 0.81
----------------------------------------------------------------
--------------------------------------------
EPOCH: 0
Loss=0.09177083522081375 Batch_id=468 Accuracy=86.25: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 11.01it/s]

Training set: Average loss: 0.0918, Accuracy: 51753/60000 (86.25%)


Test set: Average loss: 0.1716, Accuracy: 9456/10000 (94.56%)

--------------------------------------------
--------------------------------------------
EPOCH: 1
Loss=0.05261039733886719 Batch_id=468 Accuracy=97.32: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:41<00:00, 11.24it/s]

Training set: Average loss: 0.0526, Accuracy: 58392/60000 (97.32%)


Test set: Average loss: 0.0830, Accuracy: 9751/10000 (97.51%)

--------------------------------------------
--------------------------------------------
EPOCH: 2
Loss=0.03920774534344673 Batch_id=468 Accuracy=97.95: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 11.08it/s]

Training set: Average loss: 0.0392, Accuracy: 58770/60000 (97.95%)


Test set: Average loss: 0.0933, Accuracy: 9713/10000 (97.13%)

--------------------------------------------
--------------------------------------------
EPOCH: 3
Loss=0.06313475221395493 Batch_id=468 Accuracy=98.26: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 10.99it/s]

Training set: Average loss: 0.0631, Accuracy: 58957/60000 (98.26%)


Test set: Average loss: 0.0659, Accuracy: 9786/10000 (97.86%)

--------------------------------------------
--------------------------------------------
EPOCH: 4
Loss=0.06438200920820236 Batch_id=468 Accuracy=98.45: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 11.08it/s]

Training set: Average loss: 0.0644, Accuracy: 59070/60000 (98.45%)


Test set: Average loss: 0.0531, Accuracy: 9824/10000 (98.24%)

--------------------------------------------
--------------------------------------------
EPOCH: 5
Loss=0.05566586181521416 Batch_id=468 Accuracy=98.53: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:41<00:00, 11.18it/s]

Training set: Average loss: 0.0557, Accuracy: 59118/60000 (98.53%)


Test set: Average loss: 0.0436, Accuracy: 9860/10000 (98.60%)

--------------------------------------------
--------------------------------------------
EPOCH: 6
Loss=0.013720410875976086 Batch_id=468 Accuracy=98.64: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 10.98it/s]

Training set: Average loss: 0.0137, Accuracy: 59183/60000 (98.64%)


Test set: Average loss: 0.0349, Accuracy: 9895/10000 (98.95%)

--------------------------------------------
--------------------------------------------
EPOCH: 7
Loss=0.06665966659784317 Batch_id=468 Accuracy=98.70: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 11.13it/s]

Training set: Average loss: 0.0667, Accuracy: 59220/60000 (98.70%)


Test set: Average loss: 0.0419, Accuracy: 9861/10000 (98.61%)

--------------------------------------------
--------------------------------------------
EPOCH: 8
Loss=0.11972901970148087 Batch_id=468 Accuracy=98.75: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 11.13it/s]

Training set: Average loss: 0.1197, Accuracy: 59248/60000 (98.75%)


Test set: Average loss: 0.0377, Accuracy: 9892/10000 (98.92%)

--------------------------------------------
--------------------------------------------
EPOCH: 9
Loss=0.006814613938331604 Batch_id=468 Accuracy=98.81: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 11.07it/s]

Training set: Average loss: 0.0068, Accuracy: 59283/60000 (98.81%)


Test set: Average loss: 0.0343, Accuracy: 9889/10000 (98.89%)

--------------------------------------------
--------------------------------------------
EPOCH: 10
Loss=0.08122716099023819 Batch_id=468 Accuracy=98.89: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 11.03it/s]

Training set: Average loss: 0.0812, Accuracy: 59334/60000 (98.89%)


Test set: Average loss: 0.0316, Accuracy: 9898/10000 (98.98%)

--------------------------------------------
--------------------------------------------
EPOCH: 11
Loss=0.06304547190666199 Batch_id=468 Accuracy=98.89: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 11.03it/s]

Training set: Average loss: 0.0630, Accuracy: 59332/60000 (98.89%)


Test set: Average loss: 0.0280, Accuracy: 9912/10000 (99.12%)

--------------------------------------------
--------------------------------------------
EPOCH: 12
Loss=0.011372905224561691 Batch_id=468 Accuracy=98.98: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 11.11it/s]

Training set: Average loss: 0.0114, Accuracy: 59387/60000 (98.98%)


Test set: Average loss: 0.0364, Accuracy: 9882/10000 (98.82%)

--------------------------------------------
--------------------------------------------
EPOCH: 13
Loss=0.006849141791462898 Batch_id=468 Accuracy=98.91: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:46<00:00, 10.03it/s]

Training set: Average loss: 0.0068, Accuracy: 59346/60000 (98.91%)


Test set: Average loss: 0.0289, Accuracy: 9908/10000 (99.08%)

--------------------------------------------
--------------------------------------------
EPOCH: 14
Loss=0.012854115106165409 Batch_id=468 Accuracy=99.03: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:57<00:00,  8.16it/s]

Training set: Average loss: 0.0129, Accuracy: 59415/60000 (99.03%)

^[[B
Test set: Average loss: 0.0294, Accuracy: 9905/10000 (99.05%)

--------------------------------------------
--------------------------------------------
EPOCH: 15
Loss=0.022431718185544014 Batch_id=468 Accuracy=99.00: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:46<00:00, 10.02it/s]

Training set: Average loss: 0.0224, Accuracy: 59397/60000 (99.00%)


Test set: Average loss: 0.0280, Accuracy: 9920/10000 (99.20%)

--------------------------------------------
--------------------------------------------
EPOCH: 16
Loss=0.007082412019371986 Batch_id=468 Accuracy=98.97: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 10.97it/s]

Training set: Average loss: 0.0071, Accuracy: 59383/60000 (98.97%)


Test set: Average loss: 0.0309, Accuracy: 9903/10000 (99.03%)

--------------------------------------------
--------------------------------------------
EPOCH: 17
Loss=0.012682384811341763 Batch_id=468 Accuracy=99.03: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:44<00:00, 10.60it/s]

Training set: Average loss: 0.0127, Accuracy: 59421/60000 (99.03%)


Test set: Average loss: 0.0318, Accuracy: 9906/10000 (99.06%)

--------------------------------------------
--------------------------------------------
EPOCH: 18
Loss=0.008517027832567692 Batch_id=468 Accuracy=99.03: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 11.11it/s]

Training set: Average loss: 0.0085, Accuracy: 59415/60000 (99.03%)


Test set: Average loss: 0.0269, Accuracy: 9908/10000 (99.08%)

--------------------------------------------
--------------------------------------------
EPOCH: 19
Loss=0.025283485651016235 Batch_id=468 Accuracy=99.06: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████| 469/469 [00:42<00:00, 11.01it/s]

Training set: Average loss: 0.0253, Accuracy: 59435/60000 (99.06%)


Test set: Average loss: 0.0267, Accuracy: 9917/10000 (99.17%)

--------------------------------------------
(era3_assignments) sravan@sravan-latitude-3410 ~/Personal/Courses/ERA3/Assignment7/ERAV3_Assignment7/model2 (main)$ 
'''
